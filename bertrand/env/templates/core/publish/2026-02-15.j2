{% raw %}
name: publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to re-publish (must match project version, e.g. 1.2.3)"
        required: true
        type: string

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RELEASE_TAG: ${{ github.event_name == 'release' && github.event.release.tag_name || inputs.release_tag }}

jobs:
  build:
    name: Build and publish arch images
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Validate release tag
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${RELEASE_TAG}" ]]; then
            echo "missing release tag (release event tag or workflow dispatch input)" >&2
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ env.RELEASE_TAG }}

      - uses: actions/setup-python@v5
        with:
          python-version: "{% endraw %}{{ python_version }}{% raw %}"

      - name: Install Bertrand CLI
        shell: bash
        run: |
          set -euo pipefail
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install "bertrand=={% endraw %}{{ bertrand_version }}{% raw %}"
          echo "${PWD}/.venv/bin" >> "${GITHUB_PATH}"

      - name: Bootstrap toolchain
        shell: bash
        run: |
          set -euo pipefail
          bertrand init --yes

      - name: Log in to GHCR
        shell: bash
        env:
          GHCR_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          echo "${GHCR_TOKEN}" | podman login ghcr.io --username "${GITHUB_ACTOR}" --password-stdin

      - name: Build release output
        shell: bash
        env:
          OCI_REPO: ghcr.io/${{ github.repository }}
        run: |
          set -euo pipefail
          repo="$(printf '%s' "${OCI_REPO}" | tr '[:upper:]' '[:lower:]')"
          bertrand publish --repo "${repo}" --version "${RELEASE_TAG}" .

  manifest:
    name: Publish multi-arch manifests
    needs: build
    runs-on: ubuntu-24.04
    steps:
      - name: Validate release tag
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${RELEASE_TAG}" ]]; then
            echo "missing release tag (release event tag or workflow dispatch input)" >&2
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ env.RELEASE_TAG }}

      - uses: actions/setup-python@v5
        with:
          python-version: "{% endraw %}{{ python_version }}{% raw %}"

      - name: Install Bertrand CLI
        shell: bash
        run: |
          set -euo pipefail
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install "bertrand=={% endraw %}{{ bertrand_version }}{% raw %}"
          echo "${PWD}/.venv/bin" >> "${GITHUB_PATH}"

      - name: Bootstrap toolchain
        shell: bash
        run: |
          set -euo pipefail
          bertrand init --yes

      - name: Log in to GHCR
        shell: bash
        env:
          GHCR_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          echo "${GHCR_TOKEN}" | podman login ghcr.io --username "${GITHUB_ACTOR}" --password-stdin

      - name: Assemble and push manifests
        shell: bash
        env:
          OCI_REPO: ghcr.io/${{ github.repository }}
        run: |
          set -euo pipefail
          repo="$(printf '%s' "${OCI_REPO}" | tr '[:upper:]' '[:lower:]')"
          bertrand publish --manifest --repo "${repo}" --version "${RELEASE_TAG}" .
{% endraw %}
